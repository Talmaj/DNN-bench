version: 2.1

jobs:
  test-pytorch:
    parameters:
      quantize:
        type: string
    docker:
      - image: toriml/pytorch:latest
    steps:
      - checkout
      - run:
          command: >
            apt-get update &&
            apt-get -y install curl &&
            curl -o mobilenetv2-1.0.onnx
            https://s3.amazonaws.com/onnx-model-zoo/mobilenet/mobilenetv2-1.0/mobilenetv2-1.0.onnx
          name: Download model
      - run:
          command: >
            python3 ./bench mobilenetv2-1.0.onnx
            --backend pytorch
            --repeat 10
            --number 1
            --warmup 1
            --backend-meta onnx2pytorch
            --device cpu
            --quantize << parameters.quantize >>
            --output-path results/mobilenet.json
          name: Benchmark pytorch backend
          no_output_timeout: 5m
      - run: test results/mobilenet.json

workflows:
  main:
    jobs:
      - test-pytorch:
          matrix:
            parameters:
              quantize: ["0", "1"]

